{% extends "base.html" %}

{% block title %}Mark Attendance - QR{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto text-center">
  <div class="card">
    <h1 class="text-3xl font-bold mb-4" style="color: var(--navy);">QR Code Scanned âœ“</h1>
    <p class="text-lg text-slate-600 mb-8">Click the button below to mark your attendance</p>
    
    <button onclick="markAttendance()" class="btn btn-cyan text-xl px-12 py-5">
      Mark My Attendance
    </button>

    <p class="text-sm text-slate-500 mt-6">Session ID: {{ slot_id }}</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
<script>
let visitorId = null;

FingerprintJS.load().then(fp => {
  fp.get().then(result => {
    visitorId = result.visitorId;
  });
});

async function markAttendance() {
  if (!visitorId) {
    showToast("Please wait, initializing...", "info");
    return;
  }

  try {
    const res = await fetch("/attendance/mark", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fingerprint: visitorId,
        method: "qr",
        qr_token: "{{ token }}"
      })
    });

    const data = await res.json();
    
    if (data.ok) {
      showToast(data.msg, "success");
      setTimeout(() => {
        window.location.href = "/dashboard";
      }, 1500);
    } else {
      showToast(data.msg, "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}
</script>
{% endblock %}