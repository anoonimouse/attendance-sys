{% extends 'base.html' %}
{% block content %}
<div class="min-h-[60vh] flex items-center justify-center">
  <div class="card max-w-md text-center">
    <h3 class="font-semibold">Scan QR â€” Quick Mark</h3>
    <p class="text-sm text-slate-500 mt-1">Tap Mark to confirm using QR token</p>
    <div class="mt-4">
      <button id="qrMarkBtn" class="px-4 py-2 btn-primary rounded">Mark via QR</button>
    </div>
    <div id="qres" class="mt-3 text-sm"></div>
  </div>
</div>

<script>
document.getElementById('qrMarkBtn').addEventListener('click', async function(){
  const token = "{{ token }}";
  const fingerprint = (await FingerprintJS.load()).get().then(x=>x.visitorId).catch(()=>null);
  const payload = { method: "qr", qr_token: token, fingerprint: await fingerprint };
  const res = await fetch("{{ url_for('main.mark_attendance') }}", {
    method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)
  });
  const data = await res.json();
  if(data.ok) {
    document.getElementById('qres').innerText = "Marked at " + new Date(data.timestamp).toLocaleString();
    showToast("Attendance marked via QR");
  } else {
    document.getElementById('qres').innerText = data.msg || "Failed";
    showToast(data.msg || "Failed to mark");
  }
});
</script>
{% endblock %}
