{% extends 'base.html' %}
{% block content %}
<div class="min-h-[70vh] flex items-center justify-center">
  <div class="card max-w-md w-full">
    <div class="text-center">
      <!-- Success Icon (initially hidden) -->
      <div id="successIcon" class="hidden mb-6">
        <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-[var(--cyan)] to-green-500 flex items-center justify-center text-white text-4xl">
          ‚úì
        </div>
      </div>

      <!-- QR Icon (initially visible) -->
      <div id="qrIcon" class="mb-6">
        <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-[var(--cyan)] to-[var(--navy)] flex items-center justify-center text-white text-4xl">
          üì±
        </div>
      </div>

      <h2 class="text-2xl font-bold text-slate-900 mb-2">QR Code Attendance</h2>
      <p class="text-slate-600 mb-6">Click the button below to mark your attendance</p>

      <button id="qrMarkBtn" 
              class="w-full px-6 py-4 btn-primary rounded-lg text-lg hover:opacity-90 transition">
        Mark My Attendance
      </button>

      <div id="qres" class="mt-4 text-sm"></div>

      <div class="mt-8 pt-6 border-t">
        <a href="{{ url_for('main.dashboard') }}" 
           class="text-sm text-[var(--cyan)] hover:underline">
          ‚Üê Back to Dashboard
        </a>
      </div>
    </div>
  </div>
</div>

<script src="https://openfpcdn.io/fingerprintjs/v3"></script>
<script>
document.getElementById('qrMarkBtn').addEventListener('click', async function(){
  const btn = this;
  btn.disabled = true;
  btn.innerText = 'Marking...';
  
  try {
    const token = "{{ token }}";
    const fp = await FingerprintJS.load();
    const result = await fp.get();
    const fingerprint = result.visitorId;
    
    const payload = { method: "qr", qr_token: token, fingerprint: fingerprint };
    const res = await fetch("{{ url_for('main.mark_attendance') }}", {
      method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)
    });
    const data = await res.json();
    
    if(data.ok) {
      // Hide QR icon, show success icon
      document.getElementById('qrIcon').classList.add('hidden');
      document.getElementById('successIcon').classList.remove('hidden');
      
      document.getElementById('qres').innerHTML = `
        <div class="p-4 rounded-lg bg-green-50 border border-green-200">
          <p class="font-semibold text-green-800">‚úì Attendance Marked Successfully!</p>
          <p class="text-sm text-green-700 mt-1">Recorded at ${new Date(data.timestamp).toLocaleString()}</p>
        </div>
      `;
      showToast("Attendance marked successfully!", "success");
      btn.innerText = 'Marked ‚úì';
      btn.classList.remove('btn-primary');
      btn.classList.add('bg-green-600');
    } else {
      document.getElementById('qres').innerHTML = `
        <div class="p-4 rounded-lg bg-red-50 border border-red-200">
          <p class="font-semibold text-red-800">‚úó ${data.msg || 'Failed to mark'}</p>
        </div>
      `;
      showToast(data.msg || "Failed to mark", "error");
      btn.disabled = false;
      btn.innerText = 'Try Again';
    }
  } catch (err) {
    document.getElementById('qres').innerHTML = `
      <div class="p-4 rounded-lg bg-red-50 border border-red-200">
        <p class="font-semibold text-red-800">‚úó Error: ${err.message}</p>
      </div>
    `;
    showToast("Error marking attendance", "error");
    btn.disabled = false;
    btn.innerText = 'Try Again';
  }
});
</script>
{% endblock %}
