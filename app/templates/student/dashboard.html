{% extends "base.html" %}

{% block title %}Student Dashboard{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-3xl font-bold" style="color: var(--navy);">Student Dashboard</h1>
  <p class="text-slate-600">Welcome back, {{ user.name }}!</p>
</div>

<!-- Active Session Alert -->
{% if active %}
<div class="card border-l-4" style="border-left-color: var(--cyan); margin-bottom: 24px;">
  <div class="flex items-center justify-between">
    <div>
      <h3 class="text-xl font-bold mb-2">ðŸ”´ Active Attendance Session</h3>
      <p class="text-slate-700 mb-1"><strong>Room:</strong> {{ active.room.name }}</p>
      <p class="text-slate-700 mb-1"><strong>Teacher:</strong> {{ active.opened_by_user.name }}</p>
      <p class="text-slate-700 mb-3">
        <strong>Ends at:</strong> {{ active.end_time.strftime('%I:%M %p') }}
      </p>
      {% if active.require_pin and active.pin_code %}
        <p class="text-lg font-bold" style="color: var(--cyan);">PIN: {{ active.pin_code }}</p>
      {% endif %}
    </div>
    <div>
      <button onclick="markAttendance()" class="btn btn-cyan text-lg px-8 py-4">
        Mark Attendance Now
      </button>
    </div>
  </div>
</div>
{% else %}
<div class="card border-l-4 border-slate-300 mb-6">
  <h3 class="text-lg font-semibold text-slate-600">No Active Session</h3>
  <p class="text-slate-500">There is no attendance session currently open.</p>
</div>
{% endif %}

<!-- Stats -->
<div class="grid md:grid-cols-3 gap-6 mb-8">
  <div class="stat-card">
    <div class="text-sm opacity-80 mb-1">Total Sessions</div>
    <div class="text-4xl font-bold">{{ total_sessions }}</div>
  </div>

  <div class="stat-card">
    <div class="text-sm opacity-80 mb-1">Attended</div>
    <div class="text-4xl font-bold">{{ attended }}</div>
  </div>

  <div class="stat-card">
    <div class="text-sm opacity-80 mb-1">Attendance Rate</div>
    <div class="text-4xl font-bold">{{ attendance_rate }}%</div>
  </div>
</div>

<!-- Quick Actions -->
<div class="card mb-6">
  <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
  <div class="flex gap-3">
    <a href="{{ url_for('main.history') }}" class="btn btn-primary">ðŸ“œ View History</a>
    <a href="{{ url_for('main.account') }}" class="btn btn-secondary">ðŸ‘¤ My Account</a>
  </div>
</div>

<!-- Rooms List -->
<div class="card">
  <h2 class="text-xl font-bold mb-4">Available Rooms</h2>
  {% if rooms %}
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for room in rooms %}
        <a href="{{ url_for('main.room_detail', room_id=room.id) }}" 
           class="p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition">
          <div class="font-semibold text-lg">{{ room.name }}</div>
          <div class="text-sm text-slate-600">Created by {{ room.creator.name if room.creator else 'Unknown' }}</div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-slate-600">No rooms available yet.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
<script>
let visitorId = null;

// Initialize fingerprint
FingerprintJS.load().then(fp => {
  fp.get().then(result => {
    visitorId = result.visitorId;
  });
});

async function markAttendance() {
  if (!visitorId) {
    showToast("Please wait, initializing...", "info");
    return;
  }

  {% if not active %}
    showToast("No active session", "error");
    return;
  {% endif %}

  const pin = {% if active and active.require_pin %} prompt("Enter PIN:") {% else %} null {% endif %};

  {% if active and active.require_pin %}
    if (!pin) {
      showToast("PIN required", "error");
      return;
    }
  {% endif %}

  try {
    const res = await fetch("/attendance/mark", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fingerprint: visitorId,
        method: "pin",
        pin: pin
      })
    });

    const data = await res.json();
    
    if (data.ok) {
      showToast(data.msg, "success");
      setTimeout(() => location.reload(), 1500);
    } else {
      showToast(data.msg, "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}
</script>
{% endblock %}