{% extends "base.html" %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-3xl font-bold" style="color: var(--navy);">Manage Users</h1>
    <p class="text-slate-600">Promote, demote, ban, or unban users</p>
  </div>
  <a href="{{ url_for('admin.index') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>

<!-- Search -->
<div class="card mb-6">
  <form method="GET" action="{{ url_for('admin.users') }}" class="flex gap-3">
    <input type="text" name="q" value="{{ q }}" 
           placeholder="Search by name or email..."
           class="flex-1 px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:border-[var(--cyan)]">
    <button type="submit" class="btn btn-primary">Search</button>
  </form>
</div>

<!-- Users List -->
<div class="card">
  {% if users %}
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b-2 border-slate-200">
            <th class="text-left py-3 px-4 font-semibold">User</th>
            <th class="text-left py-3 px-4 font-semibold">Role</th>
            <th class="text-left py-3 px-4 font-semibold">Status</th>
            <th class="text-left py-3 px-4 font-semibold">Joined</th>
            <th class="text-right py-3 px-4 font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
            <tr class="border-b border-slate-100 hover:bg-slate-50" id="user-{{ user.id }}">
              <td class="py-3 px-4">
                <div class="font-semibold">{{ user.name }}</div>
                <div class="text-sm text-slate-600">{{ user.email }}</div>
              </td>
              <td class="py-3 px-4">
                <span class="badge badge-{{ user.role }}" id="role-badge-{{ user.id }}">
                  {{ user.role.title() }}
                </span>
              </td>
              <td class="py-3 px-4">
                {% if user.is_banned %}
                  <span class="badge badge-banned" id="status-badge-{{ user.id }}">Banned</span>
                {% else %}
                  <span class="badge" style="background: #d1fae5; color: #065f46;" id="status-badge-{{ user.id }}">Active</span>
                {% endif %}
              </td>
              <td class="py-3 px-4 text-sm text-slate-600">
                {{ user.created_at.strftime('%b %d, %Y') if user.created_at else 'N/A' }}
              </td>
              <td class="py-3 px-4 text-right">
                <div class="flex justify-end gap-2">
                  {% if user.role == 'student' %}
                    <button onclick="promoteUser({{ user.id }})" 
                            class="btn btn-secondary btn-sm" id="promote-{{ user.id }}">
                      ‚¨ÜÔ∏è Promote
                    </button>
                  {% elif user.role == 'teacher' %}
                    <button onclick="demoteUser({{ user.id }})" 
                            class="btn btn-secondary btn-sm" id="demote-{{ user.id }}">
                      ‚¨áÔ∏è Demote
                    </button>
                  {% endif %}
                  
                  {% if not user.is_banned %}
                    <button onclick="banUser({{ user.id }})" 
                            class="btn btn-danger btn-sm" id="ban-{{ user.id }}">
                      üö´ Ban
                    </button>
                  {% else %}
                    <button onclick="unbanUser({{ user.id }})" 
                            class="btn btn-cyan btn-sm" id="unban-{{ user.id }}">
                      ‚úÖ Unban
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="text-center py-12">
      <p class="text-xl text-slate-600">No users found</p>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
async function promoteUser(uid) {
  if (!confirmAction("Promote this user to Teacher?")) return;
  
  try {
    const res = await fetch(`/admin/user/${uid}/promote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    
    if (data.ok) {
      showToast(data.msg, "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.msg, "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}

async function demoteUser(uid) {
  if (!confirmAction("Demote this user to Student?")) return;
  
  try {
    const res = await fetch(`/admin/user/${uid}/demote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    
    if (data.ok) {
      showToast(data.msg, "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.msg, "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}

async function banUser(uid) {
  if (!confirmAction("Ban this user? They will not be able to log in.")) return;
  
  try {
    const res = await fetch(`/admin/user/${uid}/ban`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    
    if (data.ok) {
      showToast(data.msg, "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.msg, "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}

async function unbanUser(uid) {
  if (!confirmAction("Unban this user?")) return;
  
  try {
    const res = await fetch(`/admin/user/${uid}/unban`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    
    if (data.ok) {
      showToast(data.msg, "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.msg, "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}
</script>
{% endblock %}