{% extends "base.html" %}

{% block title %}Teacher Dashboard{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-3xl font-bold" style="color: var(--navy);">Teacher Dashboard</h1>
  <p class="text-slate-600">Welcome, {{ current_user.name }}!</p>
</div>

<!-- Active Session Alert -->
{% if active_session %}
<div class="card border-l-4 mb-6" style="border-left-color: var(--cyan);">
  <div class="flex items-center justify-between">
    <div>
      <h3 class="text-xl font-bold mb-2">ğŸ”´ Active Session Running</h3>
      <p class="text-slate-700"><strong>Room:</strong> {{ active_session.room.name }}</p>
      <p class="text-slate-700"><strong>Started:</strong> {{ active_session.start_time.strftime('%I:%M %p') }}</p>
      <p class="text-slate-700"><strong>Ends at:</strong> {{ active_session.end_time.strftime('%I:%M %p') }}</p>
    </div>
    <div class="flex gap-3">
      <a href="{{ url_for('teacher.slot_live', slot_id=active_session.id) }}" class="btn btn-cyan">View Live</a>
      <button onclick="closeSession({{ active_session.id }})" class="btn btn-danger">End Session</button>
    </div>
  </div>
</div>
{% endif %}

<!-- Stats -->
<div class="grid md:grid-cols-3 gap-6 mb-8">
  <div class="stat-card">
    <div class="text-sm opacity-80 mb-1">Total Rooms</div>
    <div class="text-4xl font-bold">{{ total_rooms }}</div>
  </div>

  <div class="stat-card">
    <div class="text-sm opacity-80 mb-1">Total Students</div>
    <div class="text-4xl font-bold">{{ total_students }}</div>
  </div>

  <div class="stat-card">
    <div class="text-sm opacity-80 mb-1">Avg Attendance</div>
    <div class="text-4xl font-bold">{{ avg_attendance }}%</div>
  </div>
</div>

<!-- Quick Actions -->
<div class="card mb-6">
  <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
  <div class="flex flex-wrap gap-3">
    <a href="{{ url_for('teacher.open_slot') }}" class="btn btn-cyan">ğŸš€ Start New Session</a>
    <a href="{{ url_for('teacher.rooms') }}" class="btn btn-primary">ğŸ›ï¸ Manage Rooms</a>
    <a href="{{ url_for('teacher.create_room') }}" class="btn btn-secondary">â• Create Room</a>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">ğŸ‘ï¸ Student View</a>
  </div>
</div>

<!-- Recent Sessions -->
<div class="card">
  <h2 class="text-xl font-bold mb-4">Recent Sessions</h2>
  {% if recent_sessions %}
    <div class="space-y-3">
      {% for session in recent_sessions %}
        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
          <div>
            <div class="font-semibold">{{ session.room.name }}</div>
            <div class="text-sm text-slate-600">
              {{ session.start_time.strftime('%b %d, %Y at %I:%M %p') }}
            </div>
            <div class="text-sm text-slate-500">
              Attendance: {{ session.attendance_records|length }} students
            </div>
          </div>
          <div class="flex gap-2">
            {% if session.is_active %}
              <span class="badge-active">Active</span>
              <a href="{{ url_for('teacher.slot_live', slot_id=session.id) }}" class="btn btn-secondary btn-sm">View</a>
            {% else %}
              <span class="badge" style="background: #e2e8f0; color: #475569;">Closed</span>
              <a href="{{ url_for('teacher.slot_export', slot_id=session.id) }}" class="btn btn-secondary btn-sm">Export</a>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-slate-600">No sessions yet. Start your first session!</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
async function closeSession(slotId) {
  if (!confirmAction("Are you sure you want to end this session?")) return;

  try {
    const res = await fetch(`/teacher/slots/close/${slotId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });

    const data = await res.json();
    
    if (data.ok) {
      showToast(data.msg, "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.msg, "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}
</script>
{% endblock %}