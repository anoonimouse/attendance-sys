{% extends 'base.html' %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  
  <!-- Main Content -->
  <div class="lg:col-span-2 space-y-6">
    
    <!-- Header -->
    <div class="card flex items-start justify-between">
      <div>
        <h2 class="text-2xl font-bold">Teacher Portal</h2>
        <div class="text-sm text-slate-500 mt-1">{{ current_user.email }}</div>
      </div>
      <div class="flex items-center gap-3">
        <a href="{{ url_for('teacher.create_room') }}" 
           class="px-4 py-2 btn-primary rounded hover:opacity-90">
           + New Room
        </a>
        <a href="{{ url_for('teacher.open_slot') }}" 
           class="px-4 py-2 btn-cyan rounded hover:opacity-90">
           Start Session
        </a>
      </div>
    </div>

    <!-- Active Session -->
    {% if active_session %}
    <div class="card border-l-4 border-[var(--cyan)]">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="flex items-center gap-3">
            <h3 class="text-lg font-semibold">Active Session</h3>
            <span class="badge-active">LIVE</span>
          </div>
          
          <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
            <div>
              <span class="text-slate-500">Room:</span>
              <span class="font-medium ml-2">{{ active_session.room.name }}</span>
            </div>
            <div>
              <span class="text-slate-500">Started:</span>
              <span class="font-medium ml-2">{{ active_session.start_time.strftime('%I:%M %p') }}</span>
            </div>
            <div>
              <span class="text-slate-500">Ends:</span>
              <span class="font-medium ml-2">{{ active_session.end_time.strftime('%I:%M %p') }}</span>
            </div>
            {% if active_session.require_pin %}
            <div>
              <span class="text-slate-500">PIN:</span>
              <span class="font-mono font-bold text-lg ml-2">{{ active_session.pin_code }}</span>
            </div>
            {% endif %}
          </div>

          <div class="mt-4 flex gap-3">
            <a href="{{ url_for('teacher.slot_live', slot_id=active_session.id) }}"
               class="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-700">
               View Live Feed
            </a>
            <button onclick="closeSession({{ active_session.id }})"
                    class="px-4 py-2 border border-red-500 text-red-600 rounded hover:bg-red-50">
               End Session
            </button>
          </div>
        </div>

        <!-- QR Code Preview -->
        {% if not active_session.require_pin %}
        <div class="ml-4">
          <img src="{{ url_for('main.slot_qr', slot_id=active_session.id) }}" 
               class="w-32 h-32 border rounded" 
               alt="QR Code">
        </div>
        {% endif %}
      </div>
    </div>
    {% else %}
    <div class="card text-center py-10 border-2 border-dashed border-slate-200">
      <div class="w-16 h-16 mx-auto rounded-full bg-slate-100 flex items-center justify-center text-3xl">
        üìã
      </div>
      <h3 class="mt-4 text-lg font-semibold">No Active Session</h3>
      <p class="text-sm text-slate-500 mt-1">Start an attendance session to begin</p>
      <a href="{{ url_for('teacher.open_slot') }}" 
         class="mt-4 inline-block px-6 py-2 btn-cyan rounded">
         Start Session
      </a>
    </div>
    {% endif %}

    <!-- Recent Sessions -->
    <div class="card">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-lg">Recent Sessions</h3>
        <a href="{{ url_for('teacher.rooms') }}" class="text-sm text-[var(--cyan)] hover:underline">
          View All ‚Üí
        </a>
      </div>

      {% if recent_sessions %}
      <div class="space-y-3">
        {% for session in recent_sessions %}
        <div class="flex items-center justify-between p-3 border rounded hover:bg-slate-50">
          <div class="flex-1">
            <div class="font-medium">{{ session.room.name }}</div>
            <div class="text-sm text-slate-500">
              {{ session.start_time.strftime('%b %d, %Y at %I:%M %p') }}
            </div>
          </div>
          <div class="flex items-center gap-3">
            {% if session.is_active %}
            <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">Active</span>
            {% else %}
            <span class="px-2 py-1 text-xs rounded bg-slate-100 text-slate-600">Closed</span>
            {% endif %}
            <a href="{{ url_for('teacher.slot_export', slot_id=session.id) }}"
               class="px-3 py-1 text-sm border rounded hover:bg-slate-100">
               Export
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-6 text-slate-500">
        No sessions yet
      </div>
      {% endif %}
    </div>

  </div>

  <!-- Sidebar -->
  <div class="space-y-4">
    
    <!-- Stats -->
    <div class="card">
      <h4 class="font-semibold mb-4">Statistics</h4>
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <span class="text-sm text-slate-600">Total Rooms</span>
          <span class="text-2xl font-bold">{{ total_rooms }}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-sm text-slate-600">Total Students</span>
          <span class="text-2xl font-bold">{{ total_students }}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-sm text-slate-600">Avg Attendance</span>
          <span class="text-2xl font-bold text-[var(--cyan)]">{{ avg_attendance }}%</span>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <h4 class="font-semibold mb-3">Quick Actions</h4>
      <div class="space-y-2">
        <a href="{{ url_for('teacher.rooms') }}" 
           class="block px-4 py-2 border rounded hover:bg-slate-50 text-sm">
           üìö Manage Rooms
        </a>
        <a href="{{ url_for('teacher.open_slot') }}" 
           class="block px-4 py-2 border rounded hover:bg-slate-50 text-sm">
           ‚ñ∂Ô∏è Start New Session
        </a>
        <a href="{{ url_for('main.dashboard') }}" 
           class="block px-4 py-2 border rounded hover:bg-slate-50 text-sm">
           üë§ Student View
        </a>
      </div>
    </div>

  </div>
</div>

<script>
async function closeSession(slotId) {
  if (!confirm('Are you sure you want to end this session?')) return;
  
  try {
    const res = await fetch(`/teacher/slots/close/${slotId}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    
    const data = await res.json();
    
    if (data.ok) {
      showToast('Session ended successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.msg || 'Failed to end session', 'error');
    }
  } catch (err) {
    showToast('Error ending session', 'error');
  }
}
</script>
{% endblock %}