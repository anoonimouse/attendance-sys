{% extends "base.html" %}

{% block title %}Teacher Dashboard{% endblock %}

{% block content %}
<div class="mb-4 sm:mb-6">
  <h1 class="text-2xl sm:text-3xl font-bold" style="color: var(--navy);">Teacher Dashboard</h1>
  <p class="text-sm sm:text-base text-slate-600">Welcome, {{ current_user.name }}!</p>
</div>

<!-- Active Session Alert -->
{% if active_session %}
<div class="card border-l-4 mb-4 sm:mb-6" style="border-left-color: var(--cyan);">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex-1">
      <h3 class="text-lg sm:text-xl font-bold mb-2">ğŸ”´ Active Session Running</h3>
      <p class="text-sm sm:text-base text-slate-700"><strong>Room:</strong> {{ active_session.room.name }}</p>
      <p class="text-sm sm:text-base text-slate-700"><strong>Started:</strong> {{ active_session.start_time.strftime('%I:%M %p') }}</p>
      <p class="text-sm sm:text-base text-slate-700"><strong>Ends at:</strong> {{ active_session.end_time.strftime('%I:%M %p') }}</p>
    </div>
    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
      <a href="{{ url_for('teacher.slot_live', slot_id=active_session.id) }}" class="btn btn-cyan w-full sm:w-auto">View Live</a>
      <button onclick="closeSession({{ active_session.id }})" class="btn btn-danger w-full sm:w-auto">End Session</button>
    </div>
  </div>
</div>
{% endif %}

<!-- Stats -->
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
  <div class="stat-card">
    <div class="text-xs sm:text-sm opacity-80 mb-1">Total Rooms</div>
    <div class="text-3xl sm:text-4xl font-bold">{{ total_rooms }}</div>
  </div>

  <div class="stat-card">
    <div class="text-xs sm:text-sm opacity-80 mb-1">Total Students</div>
    <div class="text-3xl sm:text-4xl font-bold">{{ total_students }}</div>
  </div>

  <div class="stat-card sm:col-span-2 md:col-span-1">
    <div class="text-xs sm:text-sm opacity-80 mb-1">Avg Attendance</div>
    <div class="text-3xl sm:text-4xl font-bold">{{ avg_attendance }}%</div>
  </div>
</div>

<!-- Quick Actions -->
<div class="card mb-4 sm:mb-6">
  <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4">Quick Actions</h2>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
    <a href="{{ url_for('teacher.open_slot') }}" class="btn btn-cyan w-full">ğŸš€ Start New Session</a>
    <a href="{{ url_for('teacher.rooms') }}" class="btn btn-primary w-full">ğŸ›ï¸ Manage Rooms</a>
    <a href="{{ url_for('teacher.create_room') }}" class="btn btn-secondary w-full">â• Create Room</a>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary w-full">ğŸ‘ï¸ Student View</a>
  </div>
</div>

<!-- Recent Sessions -->
<div class="card">
  <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4">Recent Sessions</h2>
  {% if recent_sessions %}
    <div class="space-y-3">
      {% for session in recent_sessions %}
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-3 sm:p-4 bg-slate-50 rounded-lg">
          <div class="flex-1">
            <div class="font-semibold text-base sm:text-lg">{{ session.room.name }}</div>
            <div class="text-xs sm:text-sm text-slate-600">
              {{ session.start_time.strftime('%b %d, %Y at %I:%M %p') }}
            </div>
            <div class="text-xs sm:text-sm text-slate-500">
              Attendance: {{ session.attendance_records|length }} students
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-2">
            {% if session.is_active %}
              <span class="badge-active text-center">Active</span>
              <a href="{{ url_for('teacher.slot_live', slot_id=session.id) }}" class="btn btn-secondary btn-sm w-full sm:w-auto">View</a>
            {% else %}
              <span class="badge text-center" style="background: #e2e8f0; color: #475569;">Closed</span>
              <a href="{{ url_for('teacher.slot_export', slot_id=session.id) }}" class="btn btn-secondary btn-sm w-full sm:w-auto">Export</a>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-sm sm:text-base text-slate-600">No sessions yet. Start your first session!</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
async function closeSession(slotId) {
  if (!confirmAction("Are you sure you want to end this session?")) return;

  try {
    const res = await fetch(`/teacher/slots/close/${slotId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });

    const data = await res.json();
    
    if (data.ok) {
      showToast(data.msg, "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.msg, "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}
</script>
{% endblock %}