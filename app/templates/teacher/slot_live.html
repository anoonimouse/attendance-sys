{% extends "base.html" %}

{% block title %}Live Attendance - {{ room.name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold" style="color: var(--navy);">Live Attendance Monitor</h1>
      <p class="text-slate-600">{{ room.name }} - Session #{{ slot.id }}</p>
    </div>
    <div class="flex gap-3">
      {% if slot.is_active %}
        <button onclick="closeSession()" class="btn btn-danger">End Session</button>
      {% endif %}
      <a href="{{ url_for('teacher.dashboard') }}" class="btn btn-secondary">‚Üê Back</a>
    </div>
  </div>

  <!-- Session Info Card -->
  <div class="card mb-6">
    <div class="grid md:grid-cols-3 gap-6">
      <div>
        <label class="text-sm font-semibold text-slate-600">Status</label>
        <p class="text-lg">
          {% if slot.is_active %}
            <span class="badge-active">Active</span>
          {% else %}
            <span class="badge" style="background: #e2e8f0; color: #475569;">Closed</span>
          {% endif %}
        </p>
      </div>

      <div>
        <label class="text-sm font-semibold text-slate-600">Started</label>
        <p class="text-lg">{{ slot.start_time.strftime('%I:%M %p') }}</p>
      </div>

      <div>
        <label class="text-sm font-semibold text-slate-600">Ends At</label>
        <p class="text-lg">{{ slot.end_time.strftime('%I:%M %p') }}</p>
      </div>

      {% if slot.require_pin %}
      <div>
        <label class="text-sm font-semibold text-slate-600">PIN Code</label>
        <p class="text-2xl font-bold" style="color: var(--cyan);">{{ slot.pin_code }}</p>
      </div>
      {% endif %}

      <div>
        <label class="text-sm font-semibold text-slate-600">Total Attendance</label>
        <p class="text-2xl font-bold" id="totalCount">0</p>
      </div>
    </div>
  </div>

  <!-- QR Code Display -->
  <div class="card mb-6 text-center">
    <h2 class="text-xl font-bold mb-4">QR Code for Students</h2>
    <img src="{{ url_for('main.slot_qr', slot_id=slot.id) }}" 
         alt="QR Code" 
         class="mx-auto"
         style="max-width: 300px; border: 4px solid var(--navy); border-radius: 12px; padding: 16px; background: white;">
    <p class="text-sm text-slate-500 mt-4">Students can scan this QR code to mark attendance</p>
  </div>

  <!-- Live Attendance List -->
  <div class="card">
    <h2 class="text-xl font-bold mb-4">Live Attendance Feed</h2>
    <div id="attendanceList" class="space-y-2">
      <p class="text-slate-600">Loading...</p>
    </div>
  </div>

  <!-- Export Button -->
  <div class="mt-6 text-center">
    <a href="{{ url_for('teacher.slot_export', slot_id=slot.id) }}" 
       class="btn btn-primary">üìä Export to CSV</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let refreshInterval;

async function fetchAttendance() {
  try {
    const res = await fetch("/teacher/slots/{{ slot.id }}/feed");
    const data = await res.json();
    
    if (data.ok) {
      document.getElementById("totalCount").textContent = data.total;
      
      const list = document.getElementById("attendanceList");
      if (data.records.length === 0) {
        list.innerHTML = '<p class="text-slate-600">No attendance records yet</p>';
      } else {
        list.innerHTML = data.records.map(r => `
          <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
            <div>
              <div class="font-semibold">${r.name}</div>
              <div class="text-sm text-slate-600">${r.email}</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-slate-600">${new Date(r.timestamp).toLocaleTimeString()}</div>
              <span class="badge" style="background: #dbeafe; color: #1e40af;">${r.method.toUpperCase()}</span>
            </div>
          </div>
        `).join('');
      }

      // Stop auto-refresh if session ended
      if (!data.is_active && refreshInterval) {
        clearInterval(refreshInterval);
        showToast("Session has ended", "info");
      }
    }
  } catch (e) {
    console.error("Error fetching attendance:", e);
  }
}

async function closeSession() {
  if (!confirmAction("Are you sure you want to end this session?")) return;

  try {
    const res = await fetch("/teacher/slots/close/{{ slot.id }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });

    const data = await res.json();
    
    if (data.ok) {
      showToast(data.msg, "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.msg, "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}

// Initial fetch
fetchAttendance();

// Auto-refresh every 3 seconds
refreshInterval = setInterval(fetchAttendance, 3000);
</script>
{% endblock %}