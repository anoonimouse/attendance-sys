{% extends 'base.html' %}
{% block content %}
<div class="max-w-6xl mx-auto">
  
  <!-- Header -->
  <div class="card mb-6">
    <div class="flex items-start justify-between">
      <div class="flex-1">
        <h2 class="text-2xl font-bold">Live Attendance Monitor</h2>
        <div class="text-sm text-slate-500 mt-1">{{ room.name }}</div>
        
        <div class="mt-4 grid grid-cols-4 gap-4 text-sm">
          <div>
            <span class="text-slate-500">Session ID:</span>
            <span class="font-medium ml-2">{{ slot.id }}</span>
          </div>
          <div>
            <span class="text-slate-500">Started:</span>
            <span class="font-medium ml-2">{{ slot.start_time.strftime('%I:%M %p') }}</span>
          </div>
          <div>
            <span class="text-slate-500">Ends:</span>
            <span class="font-medium ml-2">{{ slot.end_time.strftime('%I:%M %p') }}</span>
          </div>
          <div>
            <span class="text-slate-500">Status:</span>
            {% if slot.is_active %}
            <span class="ml-2 badge-active">Active</span>
            {% else %}
            <span class="ml-2 px-2 py-1 text-xs rounded bg-slate-500 text-white">Closed</span>
            {% endif %}
          </div>
        </div>

        {% if slot.require_pin %}
        <div class="mt-4 p-4 bg-slate-50 rounded-lg inline-block">
          <div class="text-sm text-slate-600 mb-1">Session PIN:</div>
          <div class="font-mono font-bold text-3xl">{{ slot.pin_code }}</div>
        </div>
        {% endif %}
      </div>

      <!-- QR Code -->
      {% if not slot.require_pin %}
      <div class="ml-6">
        <div class="text-center">
          <img src="{{ url_for('main.slot_qr', slot_id=slot.id) }}" 
               class="w-48 h-48 border-2 border-slate-200 rounded-lg" 
               alt="QR Code">
          <div class="text-xs text-slate-500 mt-2">Scan to mark attendance</div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="mt-6 flex gap-3">
      {% if slot.is_active %}
      <button onclick="endSession()" 
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
        End Session
      </button>
      {% endif %}
      <a href="{{ url_for('teacher.slot_export', slot_id=slot.id) }}"
         class="px-4 py-2 border rounded hover:bg-slate-100">
        üì• Export CSV
      </a>
      <a href="{{ url_for('teacher.dashboard') }}"
         class="px-4 py-2 border rounded hover:bg-slate-100">
        ‚Üê Back to Dashboard
      </a>
      <button onclick="toggleAutoRefresh()" id="refreshToggle"
              class="px-4 py-2 border rounded hover:bg-slate-100">
        üîÑ Auto-refresh: ON
      </button>
    </div>
  </div>

  <!-- Live Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="card text-center">
      <div class="text-3xl font-bold text-[var(--cyan)]" id="totalCount">0</div>
      <div class="text-sm text-slate-500 mt-1">Total Attendance</div>
    </div>
    <div class="card text-center">
      <div class="text-3xl font-bold" id="recentCount">0</div>
      <div class="text-sm text-slate-500 mt-1">Last 5 Minutes</div>
    </div>
    <div class="card text-center">
      <div class="text-3xl font-bold text-slate-600" id="timeRemaining">--:--</div>
      <div class="text-sm text-slate-500 mt-1">Time Remaining</div>
    </div>
  </div>

  <!-- Attendance Feed -->
  <div class="card">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold text-lg">Live Attendance Feed</h3>
      <div class="text-sm text-slate-500" id="lastUpdate">Last updated: --</div>
    </div>

    <div id="feedContainer" class="space-y-2 max-h-[600px] overflow-y-auto">
      <div class="text-center py-10 text-slate-400">
        <div class="text-4xl mb-2">üìä</div>
        <div>Loading attendance records...</div>
      </div>
    </div>
  </div>

</div>

<script>
const SLOT_ID = {{ slot.id }};
const END_TIME = new Date("{{ slot.end_time.isoformat() }}");
let autoRefresh = true;
let refreshInterval;

// Update time remaining
function updateTimeRemaining() {
  const now = new Date();
  const diff = Math.max(0, (END_TIME - now) / 1000);
  const mm = Math.floor(diff / 60);
  const ss = Math.floor(diff % 60).toString().padStart(2, '0');
  document.getElementById('timeRemaining').innerText = mm + ':' + ss;
  
  if (diff <= 0) {
    clearInterval(refreshInterval);
    document.getElementById('timeRemaining').innerText = 'Ended';
  }
}

// Fetch attendance feed
async function fetchFeed() {
  try {
    const res = await fetch(`/teacher/slot/${SLOT_ID}/feed`);
    const data = await res.json();
    
    if (!data.ok) {
      console.error('Failed to fetch feed');
      return;
    }

    updateFeed(data.records);
    updateStats(data.records);
    
    document.getElementById('lastUpdate').innerText = 
      'Last updated: ' + new Date().toLocaleTimeString();
      
  } catch (err) {
    console.error('Error fetching feed:', err);
  }
}

// Update feed display
function updateFeed(records) {
  const container = document.getElementById('feedContainer');
  
  if (records.length === 0) {
    container.innerHTML = `
      <div class="text-center py-10 text-slate-400">
        <div class="text-4xl mb-2">üì≠</div>
        <div>No attendance marked yet</div>
      </div>
    `;
    return;
  }

  container.innerHTML = records.map((r, idx) => `
    <div class="flex items-center justify-between p-3 border rounded hover:bg-slate-50" 
         style="animation: slideIn 0.3s ease ${idx * 0.05}s both">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-semibold text-sm">
          ${getInitials(r.name)}
        </div>
        <div>
          <div class="font-medium">${r.name}</div>
          <div class="text-sm text-slate-500">${r.email}</div>
        </div>
      </div>
      <div class="text-right">
        <div class="text-sm font-medium">${new Date(r.timestamp).toLocaleTimeString()}</div>
        <div class="text-xs text-slate-500">${r.method.toUpperCase()}</div>
      </div>
    </div>
  `).join('');
}

// Update statistics
function updateStats(records) {
  document.getElementById('totalCount').innerText = records.length;
  
  // Count recent (last 5 minutes)
  const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000);
  const recent = records.filter(r => new Date(r.timestamp) > fiveMinAgo).length;
  document.getElementById('recentCount').innerText = recent;
}

// Helper: Get initials from name
function getInitials(name) {
  const parts = name.split(' ');
  if (parts.length >= 2) {
    return parts[0][0] + parts[1][0];
  }
  return name[0] || '?';
}

// Toggle auto-refresh
function toggleAutoRefresh() {
  autoRefresh = !autoRefresh;
  const btn = document.getElementById('refreshToggle');
  btn.innerText = `üîÑ Auto-refresh: ${autoRefresh ? 'ON' : 'OFF'}`;
  
  if (autoRefresh) {
    refreshInterval = setInterval(fetchFeed, 3000);
    fetchFeed();
  } else {
    clearInterval(refreshInterval);
  }
}

// End session
async function endSession() {
  if (!confirm('End this session? Students will no longer be able to mark attendance.')) {
    return;
  }
  
  try {
    const res = await fetch(`/teacher/slots/close/${SLOT_ID}`, {
      method: 'POST'
    });
    const data = await res.json();
    
    if (data.ok) {
      showToast('Session ended', 'success');
      setTimeout(() => window.location.href = '/teacher/dashboard', 1500);
    } else {
      showToast(data.msg || 'Failed to end session', 'error');
    }
  } catch (err) {
    showToast('Error ending session', 'error');
  }
}

// Initialize
updateTimeRemaining();
setInterval(updateTimeRemaining, 1000);

fetchFeed();
refreshInterval = setInterval(fetchFeed, 3000);

// Animation
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}